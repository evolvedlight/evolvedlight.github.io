<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Creating Kerberos secured connections from Dotnet on Linux | steve's blog</title>
    <meta name="description" content="c#, paragliding, sports">
    <link rel="preload stylesheet" href="/assets/style.07528792.css" as="style">
    <script type="module" src="/assets/app.97c03730.js"></script>
    <link rel="modulepreload" href="/assets/chunks/framework.f55bdc3d.js">
  <link rel="modulepreload" href="/assets/posts_dotnet-kerberos.md.d4b493b9.lean.js">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="antialiased dark:bg-slate-900"><div class="max-w-3xl mx-auto px-4 sm:px-6 xl:max-w-5xl xl:px-0"><nav class="flex justify-between items-center py-10 font-bold"><a class="text-xl" href="/" aria-label="steve&#39;s blog"><img class="inline-block mr-2" style="width:100px;height:100px;" alt="logo" src="/logo.webp"><span class="hidden md:inline dark:text-white">steve&#39;s blog</span></a><div class="text-sm text-gray-500 dark:text-white leading-5"><a class="hover:text-gray-700 dark:hover:text-gray-200" href="https://github.com/evolvedlight/evolvedlight.github.io" target="_blank" rel="noopener"><span class="hidden sm:inline">GitHub </span>Source</a><span class="mr-2 ml-2">·</span><a class="hover:text-gray-700 dark:hover:text-gray-200" href="/feed.rss">RSS<span class="hidden sm:inline"> Feed</span></a></div></nav></div><main class="max-w-3xl mx-auto px-4 sm:px-6 xl:max-w-5xl xl:px-0"><article class="xl:divide-y xl:divide-gray-200 dark:xl:divide-slate-200/5"><header class="pt-6 xl:pb-10 space-y-1 text-center"><dl><dt class="sr-only">Published on</dt><dd class="text-base leading-6 font-medium text-gray-500 dark:text-gray-300"><time datetime="2023-08-05T12:00:00.000Z">August 5, 2023</time></dd></dl><h1 class="text-3xl leading-9 font-extrabold text-gray-900 dark:text-white tracking-tight sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Creating Kerberos secured connections from Dotnet on Linux</h1></header><div class="divide-y xl:divide-y-0 divide-gray-200 dark:divide-slate-200/5 xl:grid xl:grid-cols-4 xl:gap-x-10 pb-16 xl:pb-20" style="grid-template-rows:auto 1fr;"><dl class="pt-6 pb-10 xl:pt-11 xl:border-b xl:border-gray-200 dark:xl:border-slate-200/5"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center xl:block space-x-8 sm:space-x-12 xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><!----><dl class="text-sm font-medium leading-5 whitespace-nowrap"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-white">Stephen Brown</dd><!----><!----></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-slate-200/5 xl:pb-0 xl:col-span-3 xl:row-span-2"><div style="position:relative;" class="prose dark:prose-invert max-w-none pt-10 pb-8"><div><p>For the last few years at my workplace we&#39;ve been using Kerberos authentication to connect to the on-prem SQL Server databases. On Windows this just worked like magic, as the services ran as a Windows domain user and so could connect to the database without any additional configuration. However, when moving to Kubernetes and Linux systems, this didn&#39;t work out of the box.</p><p>Our initial solution was following this <a href="https://cloud.redhat.com/blog/kerberos-sidecar-container" target="_blank" rel="noreferrer">red hat blog post</a> which details how to setup a sidecar which keeps a kerberos token valid. This worked for a number of years but did have some problems:</p><ul><li>We ran 100+ containers and each needed a sidecar - this cost a few gigabytes of memory and some CPU allowance</li><li>When the token was being refreshed, it was not available for a few milliseconds</li><li>It was extra hassle and created slightly larger deployments and more complex Deployment configs.</li></ul><p>When investigating a seperate issue (dotnet 7 caused some transient kerberos faults) we realised that actually the whole sidecar approach was completely unneccessary! This post will give the minimum you actually need to call Keberos services from Linux</p><ol><li>You&#39;ll need to add the keberos tools to your docker image. Maybe you have a base image you share, maybe not. For alpine images:</li></ol><p><code>RUN apk add --no-cache krb5</code></p><ol start="2"><li>You&#39;ll need to have a krb5 configuration that points to your domain controller. Microsoft has an <a href="https://learn.microsoft.com/en-us/sql/connect/jdbc/using-kerberos-integrated-authentication-to-connect-to-sql-server?view=sql-server-ver16#creating-a-kerberos-configuration-file" target="_blank" rel="noreferrer">example</a></li></ol><p>For example, ours looks like this:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">[logging]</span></span>
<span class="line"><span style="color:#A6ACCD;">default</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">[libdefaults]</span></span>
<span class="line"><span style="color:#A6ACCD;">...standard things here</span></span>
<span class="line"><span style="color:#A6ACCD;">default_client_keytab_name=/krb5/client.keytab</span></span>
<span class="line"><span style="color:#A6ACCD;">default_keytab_name=/krb5/krb5.keytab</span></span>
<span class="line"><span style="color:#A6ACCD;">default_ccache_name=FILE:/dev/shm/ccache</span></span>
<span class="line"><span style="color:#A6ACCD;">default_realm = EXAMPLE.COM</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">[realms]</span></span>
<span class="line"><span style="color:#A6ACCD;">EXAMPLE.COM = {</span></span>
<span class="line"><span style="color:#A6ACCD;">    kdc = ADS.EXAMPLE.COM:88</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div><p>You can then add this to the docker image like</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">RUN mkdir /krb5 &amp;&amp; mkdir /customkrb5</span></span>
<span class="line"><span style="color:#A6ACCD;">COPY krb5.conf /customkrb5/krb5.conf</span></span>
<span class="line"><span style="color:#A6ACCD;">ENV KRB5_CONFIG=/customkrb5/krb5.conf</span></span></code></pre></div><p>We put it in a custom folder as some container systems have the limitation that mounting a directory overrides all files in that directory (we&#39;ll do this later)</p><ol start="3"><li><p>You then need a keytab added to the image. You will probably want this done at runtime. Get a keytab (maybe off your AD system administrators, maybe you create it yourself with ktutil) and make sure this ends up at /krb5/client.keytab. We use kubernetes secrets and volume mounts for this</p></li><li><p>Connect to the database using <code>Integrated Security=true</code>. This should now just work. You can check by calling <code>klist</code> inside the container to see that it has a ticket</p></li></ol></div></div></div><footer class="text-sm font-medium leading-5 divide-y divide-gray-200 dark:divide-slate-200/5 xl:col-start-1 xl:row-start-2"><!----><div class="py-8"><h2 class="text-xs tracking-wide uppercase text-gray-500 dark:text-white"> Previous Article </h2><div class="link"><a href="/posts/init7-tv7">TV7 (IPTV from Init7) with Dream Machine and Unity Dream machine</a></div></div><div class="pt-8"><a class="link" href="/">← Back to the blog</a></div></footer></div></article></main></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"posts_init7-tv7.md\":\"800eae85\",\"posts_github-actions-net7-docker.md\":\"8901ce83\",\"posts_dotnet-kerberos.md\":\"d4b493b9\",\"index.md\":\"627b3dc9\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"steve's blog\",\"description\":\"c#, paragliding, sports\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Home\",\"link\":\"/\"}],\"search\":{\"provider\":\"local\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/vuejs/vitepress\"}]},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":true}")</script>
    
  </body>
</html>